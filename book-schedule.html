<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="theme.css">
<title>Booking Calendar</title>
<style>
  /* same pastel/glow styles as admin page */
  #calendar-container { max-width:900px; margin:0 auto; }
  #calendar-nav { display:flex; justify-content:space-between; align-items:center; margin:20px 0; }
  #calendar-nav button { padding:8px 16px; }
  #calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; margin-bottom:40px; }
  .day { background-color:var(--card-bg); border:1px solid var(--secondary-color); border-radius:10px; padding:8px; min-height:80px; box-shadow:var(--card-shadow); cursor:pointer; transition:all 0.2s ease; }
  .day:hover { background-color: var(--accent-color); color:#fff; }
  .date-number { font-weight:bold; margin-bottom:5px; }
  .event { color:#fff; font-size:12px; padding:2px 5px; border-radius:5px; margin-top:2px; display:block; text-overflow:ellipsis; overflow:hidden; white-space:nowrap; }
  .today { border:2px solid var(--primary-color); box-shadow:0 0 12px var(--primary-color); }
  .past { opacity:0.5; }
  .weekdays { display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:5px; }
  .weekday { text-align:center; font-weight:bold; color:var(--primary-color); text-shadow:var(--glow); }
  #eventModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:flex; justify-content:center; align-items:center; z-index:1000; }
  .modal-content { background-color:var(--card-bg); border-radius:12px; padding:20px; max-width:400px; width:90%; box-shadow:var(--card-shadow); }
  .modal-content h3 { margin-top:0; color:var(--primary-color); text-shadow:var(--glow); }
  .close-btn { background:var(--secondary-color); color:#fff; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; float:right; }
  .event-item { padding:5px; margin:5px 0; border-radius:6px; color:#fff; font-weight:bold; }
</style>
</head>
<body>
<h1 style="text-align:center;">Artemis Lawn & Leaf - Booking Availability</h1>

<div id="calendar-container">
  <div id="calendar-nav">
    <button id="prevMonth">&lt; Previous</button>
    <h2 id="monthYear"></h2>
    <button id="nextMonth">Next &gt;</button>
  </div>

  <div class="weekdays">
    <div class="weekday">Sun</div>
    <div class="weekday">Mon</div>
    <div class="weekday">Tue</div>
    <div class="weekday">Wed</div>
    <div class="weekday">Thu</div>
    <div class="weekday">Fri</div>
    <div class="weekday">Sat</div>
  </div>

  <div id="calendar"></div>
</div>

<!-- Event Modal -->
<div id="eventModal">
  <div class="modal-content">
    <button class="close-btn" id="closeModal">Close</button>
    <h3 id="modalDate"></h3>
    <div id="modalEvents"></div>
  </div>
</div>

<script>
// Calendar Elements
const calendarDiv = document.getElementById('calendar');
const monthYearHeader = document.getElementById('monthYear');
const prevBtn = document.getElementById('prevMonth');
const nextBtn = document.getElementById('nextMonth');
const modal = document.getElementById('eventModal');
const modalDate = document.getElementById('modalDate');
const modalEvents = document.getElementById('modalEvents');
const closeModal = document.getElementById('closeModal');

// Add a ‚Äúlast updated‚Äù label under the calendar
const updateLabel = document.createElement('p');
updateLabel.style.textAlign = "center";
updateLabel.style.fontSize = "0.9em";
updateLabel.style.opacity = "0.7";
updateLabel.style.marginTop = "-20px";
updateLabel.id = "updateLabel";
calendarDiv.insertAdjacentElement('afterend', updateLabel);

// Event storage
let events = [];

// Type colors
const typeColors = {
  "Leaf Cleanup": "#FF8C42",
  "Snow Removal": "#42A5FF",
  "Closed": "#db5856",
  "Other": "#FFD27F"
};

let today = new Date();
let currentMonth = today.getMonth();
let currentYear = today.getFullYear();

// üü¢ Fetch and Parse ICS
async function loadICS(showLoading = true) {
  try {
    if (showLoading) {
      calendarDiv.innerHTML = "<p style='grid-column: span 7; text-align:center;'>Loading calendar...</p>";
    }

    const response = await fetch("https://artielawnandleaf.com/events.ics?nocache=" + Date.now());
    if (!response.ok) throw new Error("Failed to fetch .ics file");

    const data = await response.text();
    events = parseICS(data);

    renderCalendar(currentMonth, currentYear);
    updateLabel.textContent = "Last updated: " + new Date().toLocaleString();
  } catch (err) {
    console.error("Error loading ICS:", err);
    calendarDiv.innerHTML = "<p style='grid-column: span 7; text-align:center;'>Unable to load shared calendar.</p>";
  }
}

// ü™Ñ Parse ICS
function parseICS(text) {
  const lines = text.split(/\r?\n/);
  const events = [];
  let ev = {};
  for (const line of lines) {
    if (line.startsWith("BEGIN:VEVENT")) ev = {};
    else if (line.startsWith("SUMMARY:")) ev.title = line.replace("SUMMARY:", "").trim();
    else if (line.startsWith("DTSTART:")) {
      const d = line.replace("DTSTART:", "").trim();
      ev.date = `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}`;
    }
    else if (line.startsWith("CATEGORIES:")) ev.type = line.replace("CATEGORIES:", "").trim();
    else if (line.startsWith("END:VEVENT")) events.push(ev);
  }
  return events;
}

// üóìÔ∏è Render Calendar
function daysInMonth(month, year) { return new Date(year, month + 1, 0).getDate(); }

function renderCalendar(month, year) {
  calendarDiv.innerHTML = '';
  monthYearHeader.textContent = new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });

  const firstDay = new Date(year, month, 1).getDay();
  const totalDays = daysInMonth(month, year);
  const todayDate = new Date();

  for (let i = 0; i < firstDay; i++) calendarDiv.appendChild(document.createElement('div'));

  for (let day = 1; day <= totalDays; day++) {
    const dayDiv = document.createElement('div');
    dayDiv.classList.add('day');

    const dateNumber = document.createElement('div');
    dateNumber.classList.add('date-number');
    dateNumber.textContent = day;
    dayDiv.appendChild(dateNumber);

    const currentDate = new Date(year, month, day);
    const dateStr = currentDate.toISOString().split('T')[0];

    // ‚úÖ Fix: Only highlight actual today
    if (currentDate.toDateString() === todayDate.toDateString()) {
      dayDiv.classList.add('today');
    }

    // Dim past days only if they‚Äôre before today (no multi-day issue)
    if (currentDate < new Date(todayDate.getFullYear(), todayDate.getMonth(), todayDate.getDate())) {
      dayDiv.classList.add('past');
    }

    const dayEvents = events.filter(ev => ev.date === dateStr);
    dayEvents.forEach(ev => {
      const evDiv = document.createElement('span');
      evDiv.classList.add('event');
      evDiv.style.backgroundColor = typeColors[ev.type] || typeColors["Other"];
      evDiv.textContent = ev.title;
      dayDiv.appendChild(evDiv);
    });

    // ‚úÖ Only open modal if there are events that day
    if (dayEvents.length > 0) {
      dayDiv.onclick = () => openModal(dateStr, dayEvents);
    }

    calendarDiv.appendChild(dayDiv);
  }
}

// ü™© Modal
function openModal(dateStr, dayEvents) {
  modal.style.display = 'flex';
  modalDate.textContent = new Date(dateStr).toDateString();
  modalEvents.innerHTML = '';
  dayEvents.forEach(ev => {
    const evDiv = document.createElement('div');
    evDiv.classList.add('event-item');
    evDiv.style.backgroundColor = typeColors[ev.type] || typeColors["Other"];
    evDiv.textContent = `${ev.title}`;
    modalEvents.appendChild(evDiv);
  });
}

closeModal.onclick = () => modal.style.display = 'none';
window.onclick = e => { if (e.target == modal) modal.style.display = 'none'; };

// üß≠ Navigation
prevBtn.onclick = () => {
  currentMonth--;
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  renderCalendar(currentMonth, currentYear);
};
nextBtn.onclick = () => {
  currentMonth++;
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  renderCalendar(currentMonth, currentYear);
};

// üïí Auto-refresh every hour
setInterval(() => {
  console.log("Auto-refreshing .ics...");
  loadICS(false);
}, 3600000);

// Initial load
loadICS();
</script>
  
</body>
</html>
