<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Calendar - Artemis Lawn & Leaf</title>
<link rel="stylesheet" href="theme.css" />
<style>
/* small overrides for admin modal */
.password-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:2000; }
.password-box { background:var(--card-bg); padding:24px; border-radius:12px; box-shadow:var(--card-shadow); width:320px; text-align:center; }
.password-box h2 { margin-top:0; color:var(--primary-color); }
.hidden { display:none; }
.note { font-size:13px; color:var(--secondary-color); margin-top:8px; }
</style>
</head>
<body>
<div class="password-overlay" id="pwOverlay">
  <div class="password-box">
    <h2>Admin Login</h2>
    <input id="adminPassword" type="password" placeholder="Enter password" />
    <div style="margin-top:12px;">
      <button id="unlockBtn">Unlock</button>
    </div>
    <div class="note">Enter the admin password to manage the calendar.</div>
  </div>
</div>

<h1 style="text-align:center;">Admin Calendar</h1>
<div id="calendar-container" class="hidden">
  <div id="calendar-nav">
    <button id="prevMonth">&lt; Previous</button>
    <h2 id="monthYear"></h2>
    <button id="nextMonth">Next &gt;</button>
  </div>

  <div class="weekdays">
    <div class="weekday">Sun</div>
    <div class="weekday">Mon</div>
    <div class="weekday">Tue</div>
    <div class="weekday">Wed</div>
    <div class="weekday">Thu</div>
    <div class="weekday">Fri</div>
    <div class="weekday">Sat</div>
  </div>

  <div id="calendar"></div>

  <button class="export-btn" id="exportICS">Download .ICS</button>
  <button class="export-btn" id="saveJSON" style="background:#43a047;">Save to GitHub</button>
</div>

<!-- Event Modal -->
<div id="eventModal">
  <div class="modal-content">
    <button class="close-btn" id="closeModal">X</button>
    <h3 id="modalDate"></h3>
    <div id="modalEvents"></div>
    <hr>
    <input type="text" id="eventTitle" placeholder="Event Title">
    <input type="date" id="eventDate">
    <input type="time" id="eventTime">
    <select id="eventType">
      <option value="Leaf Cleanup">Leaf Cleanup</option>
      <option value="Snow Removal">Snow Removal</option>
      <option value="Closed">Closed</option>
      <option value="Other">Other</option>
    </select>
    <button class="save-btn" id="addEvent">Add Event</button>
  </div>
</div>

<script>
const ADMIN_PASSWORD = "artielawn2025"; // change if needed
const NETLIFY_FN_URL = "/.netlify/functions/dispatch"; // <-- deploy Netlify function and set this URL if different
// Elements
const pwOverlay = document.getElementById('pwOverlay');
const unlockBtn = document.getElementById('unlockBtn');
const adminPasswordInput = document.getElementById('adminPassword');
const calendarContainer = document.getElementById('calendar-container');

unlockBtn.onclick = () => {
  if (adminPasswordInput.value === ADMIN_PASSWORD) {
    pwOverlay.style.display = 'none';
    calendarContainer.classList.remove('hidden');
    init();
  } else {
    alert('Incorrect password');
  }
};

// Calendar logic (vanilla, similar to your original)
let events = JSON.parse(localStorage.getItem('events')) || [];
const typeColors = { "Leaf Cleanup": "#FF8C42", "Snow Removal": "#42A5FF", "Closed": "#db5856", "Other": "#FFD27F" };

let today = new Date();
let currentMonth = today.getMonth();
let currentYear = today.getFullYear();
let selectedDate = null;

const calendarDiv = document.getElementById('calendar');
const monthYearHeader = document.getElementById('monthYear');
const prevBtn = document.getElementById('prevMonth');
const nextBtn = document.getElementById('nextMonth');

function daysInMonth(m,y){ return new Date(y,m+1,0).getDate(); }

function renderCalendar(month,year){
  calendarDiv.innerHTML='';
  monthYearHeader.textContent = new Date(year, month).toLocaleString('default',{ month:'long', year:'numeric' });

  const firstDay = new Date(year,month,1).getDay();
  const totalDays = daysInMonth(month,year);

  for(let i=0;i<firstDay;i++) calendarDiv.appendChild(document.createElement('div'));

  for(let day=1;day<=totalDays;day++){
    const dayDiv = document.createElement('div');
    dayDiv.classList.add('day');
    const dateNumber = document.createElement('div');
    dateNumber.classList.add('date-number');
    dateNumber.textContent = day;
    dayDiv.appendChild(dateNumber);
    const currentDate = new Date(year,month,day);
    const dateStr = currentDate.toISOString().split('T')[0];

    if(currentDate.toDateString()===today.toDateString()) dayDiv.classList.add('today');
    if(currentDate < new Date(today.getFullYear(),today.getMonth(),today.getDate())) dayDiv.classList.add('past');

    const dayEvents = events.filter? events.filter(ev=>ev.date===dateStr) : events[dateStr] || [];
    (dayEvents||[]).forEach(ev=>{
      const evDiv = document.createElement('span');
      evDiv.classList.add('event');
      evDiv.style.backgroundColor = typeColors[ev.type] || typeColors["Other"];
      evDiv.textContent = ev.title;
      dayDiv.appendChild(evDiv);
    });

    dayDiv.onclick = ()=> openModal(dateStr);
    calendarDiv.appendChild(dayDiv);
  }
}

const modal = document.getElementById('eventModal');
const modalDate = document.getElementById('modalDate');
const modalEvents = document.getElementById('modalEvents');
const closeModal = document.getElementById('closeModal');
const eventTitle = document.getElementById('eventTitle');
const eventDate = document.getElementById('eventDate');
const eventTime = document.getElementById('eventTime');
const eventType = document.getElementById('eventType');
const addEventBtn = document.getElementById('addEvent');
const exportICSBtn = document.getElementById('exportICS');
const saveJSONBtn = document.getElementById('saveJSON');

function openModal(dateStr){
  selectedDate = dateStr;
  modal.style.display = 'flex';
  modalDate.textContent = new Date(dateStr).toDateString();
  eventDate.value = dateStr;
  eventTitle.value = '';
  eventTime.value = '';
  eventType.value = 'Leaf Cleanup';
  renderModalEvents();
}

def renderModalEvents():
  modalEvents.innerHTML='';
  const dayEvents = events.filter? events.filter(ev=>ev.date===selectedDate) : events[selectedDate] || [];
  (dayEvents||[]).forEach((ev, idx)=>{
    const evDiv = document.createElement('div');
    evDiv.classList.add('event-item');
    evDiv.style.backgroundColor = typeColors[ev.type] || typeColors["Other"];
    evDiv.innerHTML = `${ev.time||'All Day'} - ${ev.title} <button class="delete-btn" data-idx="${idx}">Delete</button>`;
    evDiv.querySelector('button').onclick = ()=>{
      // remove event
      const i = events.indexOf(ev);
      if(i>-1) events.splice(i,1);
      localStorage.setItem('events', JSON.stringify(events));
      renderCalendar(currentMonth,currentYear);
      renderModalEvents();
    };
    modalEvents.appendChild(evDiv);
  });
}

addEventBtn.onclick = ()=>{
  if(!eventTitle.value.trim()) return alert('Enter a title');
  const newEv = { title:eventTitle.value, date:eventDate.value, time:eventTime.value, type:eventType.value };
  events.push(newEv);
  localStorage.setItem('events', JSON.stringify(events));
  renderCalendar(currentMonth,currentYear);
  renderModalEvents();
};

prevBtn.onclick=()=>{ currentMonth--; if(currentMonth<0){currentMonth=11; currentYear--;} renderCalendar(currentMonth,currentYear);}
nextBtn.onclick=()=>{ currentMonth++; if(currentMonth>11){currentMonth=0; currentYear++;} renderCalendar(currentMonth,currentYear);}

closeModal.onclick=()=> modal.style.display='none';
window.onclick = e=> { if(e.target==modal) modal.style.display='none'; }

// ICS generation for download
function generateICS(list){ 
  let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Artemis Lawn & Leaf//EN\n';
  (list||events).forEach(ev=>{
    const date = ev.date.replace(/-/g,'');
    let startTime='000000', endTime='010000';
    if(ev.time){
      const [h,m]=ev.time.split(':');
      startTime = `${h.padStart(2,'0')}${m.padStart(2,'0')}00`;
      const d = new Date(`${ev.date}T${ev.time}`);
      d.setHours(d.getHours()+1);
      endTime = `${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}00`;
    }
    ics += `BEGIN:VEVENT\nSUMMARY:${ev.title}\nDTSTART:${date}T${startTime}\nDTEND:${date}T${endTime}\nCATEGORIES:${ev.type}\nEND:VEVENT\n`;
  });
  ics += 'END:VCALENDAR\n';
  return ics;
}

exportICSBtn.onclick = ()=>{
  const blob = new Blob([generateICS()], { type: 'text/calendar' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'events.ics';
  link.click();
  URL.revokeObjectURL(link.href);
  alert('Downloaded .ics');
};

// Save to GitHub via secure serverless function (Netlify recommended)
saveJSONBtn.onclick = async ()=>{
  const payload = { events: events };
  try{
    const res = await fetch(NETLIFY_FN_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const txt = await res.text();
    alert(txt);
  }catch(err){
    console.error(err);
    alert('Error saving to GitHub. Make sure your Netlify function is deployed and configured.');
  }
};

function init(){
  // load local events or from data/events.json
  const local = localStorage.getItem('events');
  if(local){
    events = JSON.parse(local);
  } else {
    // try fetch public data/events.json (if present in repo)
    fetch('data/events.json').then(r=>r.ok? r.json() : null).then(d=>{ if(d) { events = d; localStorage.setItem('events', JSON.stringify(events)); renderCalendar(currentMonth,currentYear); } }).catch(()=>{});
  }
  renderCalendar(currentMonth,currentYear);
}
</script>
</body>
</html>
